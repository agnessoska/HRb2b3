-- Добавляем поле document_data в таблицу generated_documents для хранения структурированных данных
ALTER TABLE public.generated_documents ADD COLUMN IF NOT EXISTS document_data jsonb;

-- Обновляем конфигурацию моделей для генерации документов
UPDATE public.ai_models 
SET 
  model_name = 'claude-3-5-sonnet-20241022',
  max_output_tokens = 2000,
  thinking_budget = 1000
WHERE operation_type = 'interview_invitation';

UPDATE public.ai_models 
SET 
  model_name = 'claude-3-5-sonnet-20241022',
  max_output_tokens = 3000,
  thinking_budget = 1500
WHERE operation_type = 'job_offer';

UPDATE public.ai_models 
SET 
  model_name = 'claude-3-5-sonnet-20241022',
  max_output_tokens = 1500,
  thinking_budget = 800
WHERE operation_type = 'rejection_letter';

-- Обновляем промпт для приглашения на интервью
UPDATE public.ai_prompts 
SET prompt_text = 'Ты - профессиональный HR-специалист. Создай персонализированное приглашение на интервью для кандидата.

ДАННЫЕ КАНДИДАТА:
Имя: {candidate_name}
Профессиональный опыт: {candidate_experience}
Навыки: {candidate_skills}

ВАКАНСИЯ:
Должность: {vacancy_title}
Описание: {vacancy_description}
Зарплата: {salary_info}

КОМПАНИЯ:
Название: {organization_name}

ДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ ОТ HR:
{additional_info}

Создай структурированное приглашение в формате JSON со следующими полями:

{
  "greeting": "Персональное приветствие кандидата по имени",
  "introduction": "Благодарность за интерес + краткое упоминание почему кандидат выделился (на основе его опыта/навыков)",
  "interview_details": {
    "format": "предложи формат (онлайн/офлайн/гибрид)",
    "estimated_duration": "примерная длительность (60-90 минут)",
    "stages": ["Список этапов интервью: Знакомство", "Обсуждение опыта", "Технические вопросы", "Case study/практика", "Ваши вопросы"]
  },
  "preparation_checklist": ["Список из 3-5 пунктов что кандидату подготовить к интервью"],
  "what_to_expect": "Краткое описание атмосферы и процесса интервью (1-2 предложения)",
  "next_steps": "Что будет после: HR свяжется для согласования даты и времени",
  "contact_info": "Укажи что HR доступен для вопросов",
  "closing": "Теплое завершение письма"
}

ВАЖНО:
- Отвечай ТОЛЬКО валидным JSON, без markdown блоков
- Тон: профессиональный, но дружелюбный
- Упоминай конкретные детали о кандидате для персонализации
- Не указывай конкретные даты/время (их укажет HR позже)
- Язык ответа: {language}'
WHERE operation_type = 'interview_invitation';

-- Обновляем промпт для оффера
UPDATE public.ai_prompts 
SET prompt_text = 'Ты - профессиональный HR-специалист. Создай официальное предложение о работе (job offer) для кандидата.

ДАННЫЕ КАНДИДАТА:
Имя: {candidate_name}
Профессиональный опыт: {candidate_experience}
Навыки: {candidate_skills}
Сильные стороны (из анализа): {candidate_strengths}

ВАКАНСИЯ:
Должность: {vacancy_title}
Описание: {vacancy_description}
Требования: {vacancy_requirements}
Зарплата: {salary_info}

КОМПАНИЯ:
Название: {organization_name}
Культура: {organization_culture}

УСЛОВИЯ ОТ HR:
{additional_info}

Создай профессиональный оффер в формате JSON:

{
  "congratulations": "Поздравление с успешным прохождением отбора",
  "opening_statement": "Официальное предложение должности (1-2 предложения о том, почему выбрали этого кандидата)",
  "position_details": {
    "title": "Название должности из вакансии",
    "employment_type": "Тип занятости (full-time/part-time/remote)",
    "start_date": "Предложенная дата начала работы (используй информацию от HR или предложи через 2-4 недели)",
    "probation_period": "Испытательный срок (стандартно 3 месяца)"
  },
  "compensation_package": {
    "salary": "Зарплата из дополнительной информации или из вакансии",
    "bonuses": ["Список бонусов: годовой бонус", "опционы", "премии за результаты"],
    "benefits": ["Соц. пакет: ДМС", "спортзал", "обучение", "отпуск 28 дней", "гибкий график"]
  },
  "key_responsibilities": ["Список ключевых обязанностей из описания вакансии (4-6 пунктов)"],
  "growth_opportunities": "Возможности развития и карьерного роста в компании (2-3 предложения)",
  "team_info": "Информация о команде и корпоративной культуре (2-3 предложения)",
  "decision_deadline": "Укажи дедлайн принятия решения (стандартно 14 дней)",
  "next_steps": "Что делать дальше: связаться с HR для обсуждения деталей",
  "closing": "Теплое завершение с выражением надежды на сотрудничество"
}

ВАЖНО:
- Отвечай ТОЛЬКО валидным JSON
- Тон: официальный, но позитивный и мотивирующий
- Используй конкретные данные о кандидате и вакансии
- Оффер должен выглядеть серьезно и профессионально
- Подчеркни уникальную ценность кандидата
- Язык ответа: {language}'
WHERE operation_type = 'job_offer';

-- Обновляем промпт для письма с отказом
UPDATE public.ai_prompts 
SET prompt_text = 'Ты - чуткий и профессиональный HR-специалист. Создай деликатное письмо с отказом кандидату.

ДАННЫЕ КАНДИДАТА:
Имя: {candidate_name}
Профессиональный опыт: {candidate_experience}
Навыки: {candidate_skills}

ВАКАНСИЯ:
Должность: {vacancy_title}

КОМПАНИЯ:
Название: {organization_name}

ВНУТРЕННЯЯ ИНФОРМАЦИЯ (НЕ упоминай в письме):
{additional_info}

Создай вежливое письмо в формате JSON:

{
  "greeting": "Персональное приветствие по имени",
  "gratitude": "Искренняя благодарность за участие в процессе отбора и потраченное время",
  "decision_statement": "Деликатное сообщение о решении (без указания причин)",
  "positive_feedback": "Подчеркни положительные стороны кандидата на основе его опыта/навыков (будь конкретным, но не переборщи)",
  "encouragement": "Слова поддержки и веры в его профессиональные качества",
  "future_opportunities": "Приглашение следить за другими вакансиями компании, возможность рассмотрения в будущем",
  "wishes": "Искренние пожелания успехов в карьере",
  "closing": "Теплое завершение письма",
  "company_regards": "Подпись от имени компании"
}

КРИТИЧЕСКИ ВАЖНО:
- Отвечай ТОЛЬКО валидным JSON
- НЕ указывай конкретные причины отказа
- Тон: уважительный, позитивный, поддерживающий
- Избегай штампов типа "к сожалению" - будь искренним
- НЕ обещай того, что не можешь выполнить
- Сохрани достоинство кандидата и оставь двери открытыми
- Используй конкретные положительные моменты из профиля кандидата
- Письмо должно оставлять хорошее впечатление о компании
- Язык ответа: {language}'
WHERE operation_type = 'rejection_letter';